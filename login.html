<?php

if(session_id() != '' || isset($_SESSION) || session_status() === PHP_SESSION_ACTIVE) 
{
    // start sess
   session_destroy();
}

session_start();
if(isset($_SESSION["username"])) unset( $_SESSION["username"] );
if(isset($_SESSION["userid"])) unset( $_SESSION["userid"] );
if(isset($_SESSION["FirstName"])) unset( $_SESSION["FirstName"] );
if(isset($_SESSION["LastName"])) unset( $_SESSION["LastName"] );
if(isset($_SESSION["Gender"])) unset( $_SESSION["Gender"] );
if(isset($_SESSION["DateOfBirth"])) unset( $_SESSION["DateOfBirth"] );
if(isset($_SESSION["email"])) unset( $_SESSION["email"] );
if(isset($_SESSION["userrole"])) unset( $_SESSION["userrole"] );


$userid = 0;
$FirstName="";
$LastName="";
$DateOfBirth="";
$username="";
$email="";
$Gender="";
$userrole="";

    if(isset($_SERVER['HTTPS'])) $https = $_SERVER['HTTPS'];
    else $https="";
    $serverport = $_SERVER['SERVER_PORT']; 
    $servname = $_SERVER['SERVER_NAME'];  
    // If the script is running on a virtual host, this will be the value defined for that virtual host.
    $servaddr = $_SERVER['SERVER_ADDR']; 
    if($https == "") $https = "http://" ;  // alloiws https://
    $baseurl = $https . $servname . ":" . $serverport ; // build the base url, example http://localhost:80
    $self    = $_SERVER['PHP_SELF'] ;        // in a php script at the address http://example.com/foo/bar.php would be /foo/bar.php
    $webpath = dirname($_SERVER['PHP_SELF']); // in a php script at the address http://example.com/foo/bar.php would be /foo
    $fullwebpath = $baseurl . $webpath ;      // for this page would be http://localhost:80/webergasia1


    // login to DataBase credentials
    $mysqlserver = "localhost";
    $mysqldb = "teliki_ergasia";
    $mysqluser = "webapp";
    $mysqlpwd = "123456";

    $mysqluser = "root";
    $mysqlpwd = "";

    $haserror = false;
    $errormessage="";

    // if called with other verb than post we dont accept the request
    if( $_SERVER['REQUEST_METHOD'] == 'POST') 
    {

        // form url encoded data post =  usr=....&psw=....
        if(!isset($_POST["usr"])){
            $haserror = true;
            $errormessage="No Username";
        }
        else 
        {
            $usr = $_POST["usr"];
            if(!isset($_POST["psw"])){
                $haserror = true;
                $errormessage="No Password";
            }
            else 
            {
                $psw = $_POST["psw"];
                // Create connection
                $conn = new mysqli($mysqlserver, $mysqluser, $mysqlpwd, $mysqldb);
                // Check connection
                if ($conn->connect_error) {
                    $haserror = true;
                    $errormessage="Connection Error";
                }
                else
                {
                    $sql ="select `id`, `FirstName`, `LastName`, `DateOfBirth`, `Gender`, `email`, `username`, " .
                    "case when ISNULL(`userrole`) then 'visitor' else `userrole` end as userrole  from `teliki_ergasia`.`users` ".
                    " where `username`='$usr' and  `password`= '$psw' ;";
                    $validregistration = false;

                    $result = $conn->query($sql);
                    if ($result->num_rows > 0) {
                        // output data of each row
                        while($row = $result->fetch_assoc()) {
                            $validregistration=true;
                            $userid = $row["id"]; 
                            $FirstName =  $row["FirstName"];
                            $LastName =  $row["LastName"];
                            $Gender =  $row["Gender"];
                            $DateOfBirth =  $row["DateOfBirth"];
                            $username =  $row["username"];
                            $email =  $row["email"];
                            $userrole =  $row["userrole"];
                            $hasError = false;
                            $errormessage="OK";                             
                            break;
                        }
                    } 
                    if($validregistration==false)
                    {
                        $haserror = true;
                        $errormessage="User Not found or dublicate entries";
                    }
                    else
                    {
                        // --- changes 21/6
                        // --------- session_start();
                        // --- end of changes 21/6
                        $_SESSION["FirstName"] = $FirstName;
                        $_SESSION["LastName"] = $LastName;
                        $_SESSION["Gender"] = $Gender ;
                        $_SESSION["DateOfBirth"] = $DateOfBirth;
                        $_SESSION["username"] = $username;
                        $_SESSION["userid"] = $userid;
                        $_SESSION["email"] = $email;
                        $_SESSION["userrole"] = $userrole;
                        $hasError = false;
                        
                        // -- changes 21/6   !!!!!!!!!!!!!!!!!!!!
                        session_write_close();
                        // --- end of changes 21/6

                        // login is success goto basics.html
                        $url = "$baseurl/basics.html?login=success";
                        header("Location: $url");
                        // exit without any other for not to break the redirection
                        die();
                    }
                }
            }
        }
    }

?><!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./styles/navbar_style.css" rel="stylesheet">
    <link href="./styles/login_style.css" rel="stylesheet">
    <title>Είσοδος</title>
    <style>

        body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }
    </style>
</head>

<body>
    <?php include 'site-menu.php';?>
<!--
    <div class="logo">
        <img src="./media/Logo/logotop.svg" id="logo" alt="bitcoin-logo">
    </div>
    <nav class="navbar">
        <div class="navbar-links">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html">
                        <span class="icon"></span>
                        <img src="./media/Icons/icon-home.png" />
                        <span class="icon-text">Home</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="basics.html">
                        <span class="icon"></span>
                        <img src="./media/Icons/icon-basics.png" />
                        <span class="icon-text">Basics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="more.html">
                        <span class="icon"></span>
                        <img src="./media/Icons/icon-more.png" />
                        <span class="icon-text">More</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="quiz.html">
                        <span class="icon"></span>
                        <img src="./media/Icons/icon-quiz.png" />
                        <span class="icon-text">Quiz</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="sign-up.html">
                        <span class="icon"></span>
                        <img src="./media/Icons/icon-signup.png" />
                        <span class="icon-text">Sign Up</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="login.html">
                        <span class="icon"></span>
                        <img src="./media/Icons/icon-login.png" />
                        <span class="icon-text">Login</span>
                    </a>
                </li>
            </ul>
            <a href="#" class="toggle-button">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </a>
        </div>
    </nav>
-->

    <?php // DEBUG
    /*
    echo "<p>SESSION vars <br />";
    if(isset($_SESSION["FirstName"] )) echo "FirstName=".$_SESSION["FirstName"]; 
    echo "<br />";
    if(isset($_SESSION["LastName"] )) echo "LastName=".$_SESSION["LastName"]; 
    echo "<br />";
    if(isset($_SESSION["Gender"] )) echo "Gender=".$_SESSION["Gender"]; 
    echo "<br />";
    if(isset($_SESSION["DateOfBirth"] )) echo "DateOfBirth=".$_SESSION["DateOfBirth"]; 
    echo "<br />";
    if(isset($_SESSION["username"] )) echo "username=".$_SESSION["username"]; 
    echo "<br />";
    if(isset($_SESSION["userid"] )) echo "userid=".$_SESSION["userid"]; 
    echo "<br />";
    if(isset($_SESSION["email"] )) echo "email=".$_SESSION["email"]; 
    echo "<br />";
    if(isset($_SESSION["userrole"] )) echo "userrole=".$_SESSION["userrole"]; 
    echo "<br/>=== END</p>";
    */
    ?>
    
    <form action="login.html" method="post" style="border:1px solid #ccc">
        <div class="container">
            <p>Παρακαλώ προσθέστε τα στοιχεία σας για να συνδεθείτε στον λογαριασμό</p>
            <hr>
            <label for="Username"><b>Username</b></label>
            <input type="text" placeholder="Εισάγετε το username" name="usr" required>

            <label for="psw"><b>Password</b></label>
            <input type="password" placeholder="Εισάγετε το password" name="psw" required>
        
            <?php if($haserror) { ?>
            <p style="font-weight:bold; color:red;">
                <?php echo $errormessage; ?>
            </p>
            <?php } ?>

            <div class="clearfix">
                <button type="button" class="loginbtn" onclick="window.location.href='sign-up.html'">Είστε νέος χρήστης;
                    Πατήστε εδώ</button>
                <button type="submit" class="signupbtn">Είσοδος</button>
            </div>
        </div>
    </form>

    <script src="./scripts/navbar.js"></script>
</body>

</html>